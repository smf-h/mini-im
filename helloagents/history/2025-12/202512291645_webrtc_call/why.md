# 变更提案: 单聊视频通话（WebRTC）

## 需求背景
当前 mini-im 的单聊仅支持文字消息（HTTP 拉取 + WS 实时推送）。为了更贴近主流 IM 体验，需要增加“单聊视频通话”，并且支持来电弹窗、接听/拒绝/挂断、静音/关摄像头，以及通话记录（含未接来电）。

本期限定为 **Web 端（浏览器）**：同一台电脑、同一浏览器用两个窗口模拟两个人完成验收。

## 产品分析

### 目标用户与场景
- **用户群体:** 使用 Web 端进行日常沟通的用户
- **使用场景:** 单聊中临时发起视频/语音通话，快速沟通；错过来电后可追溯
- **核心痛点:** 只有文字沟通效率低；缺少“呼叫/来电/通话记录”闭环

### 价值主张与成功指标
- **价值主张:** 用最小成本接入 WebRTC，实现“单聊通话”闭环（信令 + UI + 记录）
- **成功指标:**
  - 双窗口可稳定完成：呼叫 → 来电弹窗 → 接听 → 双向音视频 → 挂断
  - 静音/关摄像头可实时生效
  - 产生通话记录：已接/拒绝/未接/失败原因可查询

### 人文关怀
- 隐私默认：通话仅在用户明确点击“发起/接听”后获取媒体权限；不在后台偷偷采集
- 可控：用户可随时静音/关闭摄像头/挂断

## 变更内容
1. 新增 Web 端单聊视频通话入口（ChatView 头部按钮）
2. 新增来电弹窗（全局覆盖层），支持接听/拒绝/挂断
3. 新增静音/关摄像头控制（不做屏幕共享/切换设备）
4. 新增通话记录（包含未接来电、拒绝、失败原因）

## 影响范围
- **模块:** frontend、gateway（WS 信令）、domain（通话记录）、db（迁移）
- **文件:** `frontend/src/views/ChatView.vue`、`frontend/src/components/AppLayout.vue`、`src/main/java/com/miniim/gateway/ws/*`、`src/main/java/com/miniim/domain/*`、`src/main/resources/db/migration/*`（预计）
- **API:** 新增通话记录查询接口；新增 WS 信令事件
- **数据:** 新增通话记录表（仅记录元数据，不存媒体内容）

## 核心场景

### 需求: 发起视频通话
**模块:** frontend + gateway
用户在单聊窗口点击“视频通话”。

#### 场景: 对方在线并接听
同一浏览器两个窗口分别登录两个账号。
- 发起方显示“呼叫中…”
- 被叫弹出“来电弹窗”，可接听/拒绝
- 接听后建立 WebRTC 连接，双方看到对方画面并可听到声音

#### 场景: 对方拒绝/忙线
- 被叫点击拒绝，发起方收到“对方已拒绝”
- 被叫正在通话中，发起方收到“对方忙线”

#### 场景: 对方未响应（未接来电）
- 被叫在超时时间内未接听（例如 30s）
- 双方产生通话记录：发起方显示“未接”，被叫显示“未接来电”

### 需求: 通话中控制
**模块:** frontend

#### 场景: 静音
- 点击静音后，本地麦克风 track 关闭，对方听不到声音

#### 场景: 关闭摄像头
- 点击关闭摄像头后，本地视频 track 关闭，对方画面变为黑屏/占位

### 需求: 通话记录
**模块:** domain + frontend

#### 场景: 事后查看
- 可查询最近通话记录（已接/拒绝/未接/失败原因、时长）

## 风险评估
- **风险:** 未配置 TURN 时，部分网络环境 WebRTC 可能无法打通（NAT/企业网）
- **缓解:** Phase1 使用公共 STUN + 本地双窗口验收；后续提供 TURN 配置项并支持服务端下发 ICE servers

