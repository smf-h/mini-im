# 变更提案: 朋友圈（MVP）

## 需求背景
当前 mini-im 以“聊天/好友/群聊”为核心，但缺少“内容型社交”能力。朋友圈（动态）可以提升用户活跃与留存，并复用已有的用户体系、好友关系与鉴权链路。

## 产品分析

### 目标用户与场景
- **用户群体:** 已建立好友关系、希望低成本分享近况的用户
- **使用场景:** 日常发动态/浏览好友动态/点赞评论互动/删除自己动态
- **核心痛点:** 仅聊天缺少“弱互动”“被动浏览”的社交触点

### 价值主张与成功指标
- **价值主张:** 用最小成本补齐“内容发布+关系可见”的社交闭环
- **成功指标:**
  - 动态发布成功率、时间线加载成功率
  - 点赞/评论互动次数
  - 日活用户（DAU）与留存（后续）

### 人文关怀
- **隐私:** MVP 默认仅好友可见（含本人可见本人动态），避免“公开暴露”
- **治理:** 文本内容走服务端违禁词替换（已有 ForbiddenWordFilter）

## 变更内容
1. 新增“动态发布/删除、时间线（仅好友）、点赞、评论（一级）”的后端能力
2. 新增前端“朋友圈”页面：发动态、列表浏览、点赞/评论、删除自己动态
3. 增加最小的权限校验：仅本人可删自己的动态；评论可删自己评论；楼主可删他人评论

## 影响范围
- **模块:**
  - domain：实体/Mapper/Service/Controller
  - common：内容过滤复用
  - frontend：新增页面与调用
- **API:**
  - `POST /moment/post/create`
  - `POST /moment/post/delete`
  - `GET /moment/feed/cursor`
  - `GET /moment/user/cursor`
  - `POST /moment/like/toggle`
  - `POST /moment/comment/create`
  - `POST /moment/comment/delete`
  - `GET /moment/comment/cursor`
- **数据:**
  - 新表：`t_moment_post`、`t_moment_like`、`t_moment_comment`

## 核心场景

### 需求: 发布动态
**模块:** domain
用户发布一条纯文本动态（≤500字），服务端落库并返回 `postId`。

#### 场景: 发布成功
已登录，文本合法
- 返回 `postId`

#### 场景: 文本含违禁词
已登录，文本包含违禁词
- 服务端替换敏感词为 `***` 后入库并返回

### 需求: 浏览时间线（仅好友）
**模块:** domain
用户浏览“好友+自己”的动态，按时间倒序分页。

#### 场景: 拉取首页
已登录，首次进入朋友圈
- 返回最新一页动态（含作者 userId、内容、点赞数、评论数等）

#### 场景: 游标分页
已登录，传入 `lastId`
- 返回 `id < lastId` 的下一页

### 需求: 点赞（可取消）
**模块:** domain
对动态点赞，再次操作则取消点赞。

#### 场景: 点赞/取消赞
已登录，目标动态对我可见
- 点赞：返回 `liked=true`
- 取消：返回 `liked=false`

### 需求: 评论（一级）
**模块:** domain
对动态发表评论（≤500字）；支持删除评论。

#### 场景: 发表评论
已登录，目标动态对我可见
- 返回 `commentId`

#### 场景: 删除评论
已登录，删除自己评论，或楼主删除他人评论
- 删除成功

### 需求: 删除自己动态
**模块:** domain
楼主删除自己的动态；同时清理其点赞/评论（或标记删除）。

#### 场景: 删除动态
已登录，且为动态作者
- 删除成功，后续查询不再返回该动态

## 风险评估
- **风险:** 时间线查询需要“好友列表 + 动态分页”，好友很多时会拖慢
- **缓解:** MVP 先走直查（简单稳定）；后续按量再做“预聚合时间线/缓存好友列表/读扩散”等优化

