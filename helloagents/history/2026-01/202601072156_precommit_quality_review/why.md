# 变更提案: 待提交代码质量审查与收敛

## 需求背景
当前工作区存在大量“待提交”变更，覆盖后端（鉴权/WS/领域服务/配置）、前端（Web）、小程序、脚本与知识库文档。变更规模较大且混杂了新增文件与修改文件，存在以下风险信号：

1. **提交范围不清晰**：可能夹带误入文件（例如重复目录、私有配置、模板资源），导致后续维护与回滚成本显著上升。
2. **关键链路异常处理不严谨**：扫描到多处 `catch (...) {}` / `catch (...) { /* ignore */ }`，涉及鉴权、WS、缓存等关键路径，容易造成“静默失败”“状态不一致”“定位困难”。
3. **调试痕迹与环境配置风险**：存在 `console.log` / `System.out.println` 等调试输出；`application.yml` 默认开启了部分 debug 日志；MiniProgram 端存在硬编码的本地地址配置。
4. **编码/换行一致性问题**：存在 LF/CRLF 警告与文档 BOM/混合换行的迹象，容易造成 diff 噪声与跨平台协作问题。

本提案目标是在不改变业务目标的前提下，对待提交内容进行**质量审查、范围收敛与风险消减**，形成可控、可验证、可分批提交的改动集。

## 变更内容
1. 明确“本次应该提交什么 / 不应该提交什么”，并形成可执行的分批提交策略。
2. 对关键链路的异常处理、日志与可观测性进行收敛（避免吞异常与无上下文日志）。
3. 清理调试代码与不应入库的文件；补齐 `.gitignore` / `.gitattributes` 以降低未来噪声。
4. 将配置与环境差异（dev/prod）做边界化处理（profile/环境变量），避免生产默认 debug 或硬编码本地地址。
5. 以可验证为导向补充/调整测试与构建检查，确保“改动可上线、可回滚、可定位”。

## 影响范围
- **模块:**
  - 后端：`com.miniim.auth`、`com.miniim.gateway`、`com.miniim.domain`、`com.miniim.common`
  - 前端：`frontend/`
  - 小程序：`miniprogram/`
  - 脚本：`scripts/`
  - 知识库：`helloagents/wiki/*`、`helloagents/CHANGELOG.md`
- **文件:**
  - 重点关注：异常处理与吞异常点、默认 debug 日志配置、调试输出、未跟踪大目录/私有配置。
- **API:**
  - 重点校验：`/auth/login` 等鉴权相关接口；WS 握手与 `AUTH/REAUTH` 协议兼容性。
- **数据:**
  - 重点校验：新增/变更的实体与迁移脚本（如 `src/main/resources/db/migration/*.sql`）的一致性与可回滚性。

## 核心场景

### 需求: 提交前质量把关
**模块:** 全仓库
在提交前对所有待提交内容进行逐项审查，并输出可执行的修复计划与提交策略。

#### 场景: 误入文件与提交范围收敛
- 预期结果：不应入库的文件被明确标记并从提交集合中移除（必要时加入 `.gitignore`）；提交拆分清晰、每个提交可解释且可验证。

#### 场景: 关键链路异常处理与可观测性
- 预期结果：关键链路不再出现“吞异常导致静默失败”；日志具备最小必要上下文与统一错误码/返回结构（如适用）。

#### 场景: 配置与环境隔离
- 预期结果：生产默认配置不含 debug；敏感值仅通过环境变量注入；客户端地址配置可按环境切换。

#### 场景: 构建与测试可验证
- 预期结果：后端 `mvn test`、前端构建（如有）、小程序 TS/构建检查可通过；新增特性具备最小回归覆盖。

## 风险评估
- **风险:** 清理误入文件可能影响现有本地开发流程（例如小程序模板目录、私有配置文件被忽略）。
  - **缓解:** 采用“先确认是否需要保留”的策略；将本地配置通过 README/示例文件引导，避免提交私有文件。
- **风险:** 收紧异常处理可能改变边界行为（从“静默忽略”变为“返回错误/记录告警”）。
  - **缓解:** 对每个吞异常点明确其业务语义：可忽略/需降级/需失败；逐个加测试或在 smoke-test 中补场景。
- **风险:** 统一换行/编码会引入大量 diff 噪声。
  - **缓解:** 通过 `.gitattributes` 先锁定规则；仅对必要文件做转换；把“格式化/换行”提交与“逻辑改动”分开提交。

