# why - WS 慢消费者背压治理（硬化方案）

## 现象与影响

慢消费者（客户端不读/延迟读）会使 Netty 出站缓冲持续堆积，常见表现：

- 内存上涨（堆外/堆内），GC 抖动，最终可能 OOM
- 全局延迟分位数飙升（P95/P99 急剧恶化），拖累正常用户
- 推送写失败/超时增多，进一步诱发补发、重连风暴等次生问题

本仓库已在单机压测中复现该问题：30% 接收端延迟 5s 读取时，E2E P99≈51s，且接收侧实例 WorkingSet 约 208MB→416MB（见 `helloagents/wiki/perf_eval_20260108.md`）。

## 目标（SLO/可验收）

在不大改代码/不改协议的前提下，建立“慢端不会拖垮整体”的系统级保护边界：

- 稳定性：60s 慢消费者重放期间，网关 WorkingSet 不出现持续线性爬升
- 即时性：普通收端 E2E P99 < 5s（慢端允许被主动断开或单独劣化）
- 可观测：能量化慢端数量、触发频率、影响范围（uid/connId 级）
- 可控性：支持配置开关与阈值调参，便于灰度与回滚

## 非目标（避免过度承诺）

- 不在本方案中追求“所有消息必达/强有序/Exactly-once”（需要 ACK/补发游标/MQ 等更大改造）
- 不在本方案中引入新中间件或分布式压测平台

