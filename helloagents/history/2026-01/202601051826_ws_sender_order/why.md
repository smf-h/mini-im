# 变更提案: WS 发送者消息不乱序（单聊/群聊）

## 需求背景
当前 WS 业务处理会把“落库/查库”等阻塞操作放到 `imDbExecutor` 异步执行；当同一发送者在同一条连接上连续发送两条消息时，如果两次异步任务完成顺序发生反转，会导致：
- 发送端收到 `ACK/ERROR` 顺序反转
- 接收端（对端/群成员）收到消息顺序反转

本次目标是：在不依赖客户端按 `id/ts` 重排的前提下，保证“同一发送者在同一条 WS Channel 上连续发送的消息”在服务端处理与下发顺序不乱序。

## 变更内容
1. 引入“每个 Channel 一条串行队列（Future 链）”的执行模型：同一 Channel 上的消息处理按入站顺序串行执行。
2. 将 `SINGLE_CHAT` / `GROUP_CHAT` 的关键路径（落库 → 回包 ACK/ERROR → 触发 push）纳入串行队列，避免线程池并发回调导致乱序。

## 影响范围
- **模块:** gateway
- **文件:** `WsSingleChatHandler` / `WsGroupChatHandler` / 新增串行队列组件与测试
- **API:** 无
- **数据:** 无

## 核心场景

### 需求: 单聊-发送者消息不乱序
**模块:** gateway

#### 场景: 同一连接连续发送两条单聊消息
同一用户同一 WS 连接，连续发送两条 `SINGLE_CHAT`。
- 预期结果: 发送端收到的 `ACK(saved)` 顺序与发送顺序一致
- 预期结果: 接收端收到的两条 `SINGLE_CHAT` 顺序与发送顺序一致

### 需求: 群聊-发送者消息不乱序
**模块:** gateway

#### 场景: 同一连接连续发送两条群聊消息
同一用户同一 WS 连接，连续发送两条 `GROUP_CHAT` 到同一个群。
- 预期结果: 发送端收到的 `ACK(saved)` 顺序与发送顺序一致
- 预期结果: 群成员收到的两条 `GROUP_CHAT` 顺序与发送顺序一致

## 风险评估
- **风险:** 串行队列可能引入同一连接上的排队延迟（上一条消息慢会阻塞下一条）。
  - **缓解:** 该约束仅限同一发送者同一连接，符合“不乱序”的业务要求；并通过超时与错误释放队列，避免永久阻塞。
- **风险:** Redis/跨实例 push 的网络不确定性可能影响“到达时间”。
  - **缓解:** 本次保证的是服务端对同一发送者的“处理与下发调用顺序”不乱序；必要时保留 `serverMsgId` 用于排障与兜底校验（不要求客户端排序）。

